#!/usr/bin/env bash

FIFO="$HOME/.dwmstat.fifo"
mkfifo "$FIFO"
trap "rm -f $FIFO; exit" EXIT

align() {
	printf "%-4s" "$1"
}

status() {
	# CPU usage
	CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8"%"}')

	# Memory usage
	MEM=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')

	# Disk usage
	DISK=$(df -h / | awk 'NR==2 {print $3 "/" $2}')

	# Date and time
	DATE=$(date +"%d.%m.%Y %H:%M")

	BATTERY=$(cat /sys/class/power_supply/BAT*/capacity | awk '{s+=$1} END {print int(s/NR)"%"}')
	if [ -z "$BATTERY" ]; then
		BATTERY="N/A"
	else 
		BATTERY="$BATTERY%"
	fi

	BATTERY=$(align $BATTERY)

	EMOJI=$(grep -q "Charging" /sys/class/power_supply/BAT*/status && echo "âš¡" || echo "ðŸ”‹")

	BATTERY="$EMOJI $BATTERY"

	VOL="N/A"
	if command -v pactl >/dev/null; then 
		VOL=$(pactl get-sink-volume @DEFAULT_SINK@ | grep -oP '\d+%' | head -1)
		MUTE=$(pactl get-sink-mute @DEFAULT_SINK@ | grep -oP 'yes|no')
		if [ "$MUTE" = "yes" ]; then
			VOL="MUTE"
		fi
	elif command -v amixer >/dev/null; then
		VOL=$(amixer sget Master | grep -o "[0-9]*%" | head -n1)
	fi

	# Output to FIFO
	echo "CPU: $(align $CPU) | MEM: $MEM | DISK: $DISK | VOL: $(align $VOL) | BAT: $BATTERY | $DATE"
}

while xsetroot -name "$(status)"; do
	sleep 10
done &

while read line < "$FIFO"; do
	xsetroot -name "$(status)"
done
